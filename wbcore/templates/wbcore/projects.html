{% extends 'wbcore/single_content.html' %}
{% load staticfiles %}
{% block single-content %}
<script src="{% static 'highmaps/proj4.js'%}"></script>
<script src="{% static 'highmaps/highmaps.js'%}"></script>
<script src="{% static 'highmaps/drilldown.js'%}"></script>
<script src="{% static 'highmaps/world-robinson-highres.js'%}"></script>
<link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

<div id="container" style="width: 900px; height: 400px"></div>
<script>

var mydata = {{project_list|safe}};

var data = Highcharts.geojson(Highcharts.maps['custom/world-robinson-highres']),
    separators = Highcharts.geojson(Highcharts.maps['custom/world-robinson-highres'], 'mapline'),
    // Some responsiveness
    small = $('#container').width() < 400;

var filtered_countries = [];
// Set drilldown pointers
$.each(data, function (f) {
    for (var i = 0; i < mydata.length; i += 1) {
        if(mydata[i].country==this.properties['iso-a2']){
            this.drilldown = this.properties['iso-a2'];
            this.value = mydata[i].number;
            this.dataLabels = {enabled: false}
            filtered_countries.push(this)
        }
    };
    console.log(this.value);
    if(this.value == undefined){this.value = null}
});

// Instantiate the map
Highcharts.mapChart('container', {
  chart: {
    events: {
      drilldown: function(e) {
        if (!e.seriesOptions) {
          var chart = this,
            mapKey = 'countries/' + e.point.drilldown.toLowerCase() +'/'+ e.point.drilldown.toLowerCase()  + '-all',
            // Handle error, the timeout is cleared on success
            fail = setTimeout(function() {
              if (!Highcharts.maps[mapKey]) {
                chart.showLoading('<i class="icon-frown"></i> Failed loading ' + e.point.name);
                fail = setTimeout(function() {
                  chart.hideLoading();
                }, 1000);
              }
            }, 3000);
            console.log(mapKey);
          // Show the spinner
          chart.showLoading('<i class="icon-spinner icon-spin icon-3x"></i>'); // Font Awesome spinner

          // Load the drilldown map
          $.getScript('https://code.highcharts.com/mapdata/' + mapKey + '.js', function() {

            data = Highcharts.geojson(Highcharts.maps[mapKey]);

            // Set a non-random bogus value
            $.each(data, function(i) {
              this.value = null;
            });
						
            // Hide loading and add series
            chart.hideLoading();
            clearTimeout(fail);
            chart.addSingleSeriesAsDrilldown(e.point, {
              name: e.point.name,
              showInLegend: false,
              mapData: Highcharts.maps[mapKey],
              dataLabels: {
                enabled: true,
                format: '{point.name}'         
              }
            });
            var filtered_projects = [];
            {% for project in projects %}
                if ('{{project.location.country.code}}'==e.point.drilldown){
                    filtered_projects.push({name: '{{project.name}}', slug: '{{project.slug}}', lat: parseFloat(String('{{project.location.lat|floatformat:11}}').replace(",", ".")), lon: parseFloat(String('{{project.location.lng}}').replace(",", "."))})                  
                    }
            {% endfor %}
            chart.addSingleSeriesAsDrilldown(e.point, {             
              type: 'mappoint',
              name: 'Projekte',
              color: '#FF9900',
              data: filtered_projects,
              tooltip: {
                headerFormat: '',
                pointFormat: '<b>{point.name}</b><br>Lat: {point.lat}, Lon: {point.lon}'
                    },
              events: {
                    click: function (e) {
                        console.log(e.point.slug);
                        window.open(e.point.slug,'_self');
                    }
                }  
            });
            chart.applyDrilldown();
          });
        }
				
        this.setTitle(null, {
          text: e.point.name
        });
      },
      drillup: function() {
        this.setTitle(null, {
          text: ''
        });
      }
    }
  },

  title: {
    text: 'Weitblick all over the world'
  },

  subtitle: {
    text: '',
    floating: true,
    align: 'right',
    y: 50,
    style: {
      fontSize: '16px'
    }
  },

  legend: small ? {} : {
    layout: 'vertical',
    align: 'right',
    verticalAlign: 'middle',
    enabled: true
  },

  colorAxis: {
    min: 0,
    minColor: '#FFC266',
    maxColor: '#FF9900',
    showInLegend: false
  },

  mapNavigation: {
    enabled: true,
    buttonOptions: {
      verticalAlign: 'bottom'
    }
  },
  
  

  plotOptions: {
    map: {
      states: {
        hover: {
          color: '#EEDD66'
        }
      }
    }
  },

  series: [{
    mapData: Highcharts.maps['custom/world-robinson-highres'],
    data: data,
    joinBy: ['iso-a2', 'drilldown'],
    name: 'projects',
    showInLegend: false,
    dataLabels: {
      enabled: true,
      format: '{point.properties.postal-code}'
    }
  }, {    	
  showInLegend: false,
    type: 'mapline',
    data: separators,
    color: 'silver',
    enableMouseTracking: false,
    animation: {
      duration: 500
    }
  }],

  drilldown: {
    activeDataLabelStyle: {
      color: '#FFFFFF',
      textDecoration: 'none',
      textOutline: '1px #000000'
    },
    drillUpButton: {
      relativeTo: 'spacingBox',
      position: {
        x: 0,
        y: 60
      }
    }
  }
});

</script>

{% if projects %}
    <div class="ui four stackable cards">
    {% for project in projects %}
        {% include 'wbcore/project_card.html' with title=project.name slug=project.slug hosts=project.hosts.all description=project.short_description|striptags country=project.location.country.name %}
    {% endfor %}
    </div>
{% else %}
    <p>No projects available!</p>
{% endif %}
{% endblock %}


